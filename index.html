<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mandala Interativa ‚Äì Prot√≥tipo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; /* fundo escuro elegante */
      --panel:#0f1630;
      --panel-2:#0c1228;
      --text:#e6e9f2;
      --muted:#a9b1c7;
      --accent:#0077c8; /* Sebrae blue */
      --chip:#101834;
    }
    html,body{height:100%;}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:radial-gradient(1200px 1200px at 85% -20%, #1e2a55 0%, #0b1020 55%);} 
    .app{display:grid; grid-template-columns: 1fr 420px; gap:16px; height:100vh; padding:16px; box-sizing:border-box;}
    header{grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.06); border-radius:16px; backdrop-filter: blur(6px);}    
    header .title{font-weight:700; letter-spacing:.3px}
    .controls{display:flex; flex-wrap:wrap; gap:8px}
    button, .file-label{appearance:none; border:none; padding:10px 12px; border-radius:12px; background:var(--chip); color:var(--text); cursor:pointer; font-weight:600; border:1px solid rgba(255,255,255,.06);} 
    button:hover,.file-label:hover{filter:brightness(1.1);} 
    .file-label{display:inline-flex; align-items:center; gap:8px}
    input[type="file"]{display:none}
    .left{position:relative; background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; display:flex; align-items:center; justify-content:center;}
    .right{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; overflow:auto}
    .card{background:var(--panel-2); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px}
    .info-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
    .name{font-size:18px; font-weight:700}
    .crumb{color:var(--muted); font-size:12px}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .chip{background:var(--chip); border:1px solid rgba(255,255,255,.06); padding:6px 8px; border-radius:999px; font-size:12px}
    .list{display:grid; gap:8px; margin-top:10px}
    .list button{width:100%; text-align:left}
    .tooltip{position:absolute; pointer-events:none; background:#000c; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; transform:translate(-50%,-120%); white-space:nowrap; opacity:0; transition:opacity .15s}
    .legend{position:absolute; left:14px; bottom:14px; display:flex; gap:6px; flex-wrap:wrap; max-width:75%}
    .legend span{display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid rgba(255,255,255,.06); padding:6px 8px; border-radius:999px; font-size:12px}
    .legend i{width:12px; height:12px; border-radius:3px; display:inline-block}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .kbd{border:1px solid rgba(255,255,255,.2); padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:rgba(255,255,255,.06)}
    @media (max-width: 980px){ .app{grid-template-columns:1fr; grid-auto-rows:minmax(0,1fr)} .left{height:56vh} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">üìç Mandala Interativa ‚Äì Prot√≥tipo</div>
      <div class="controls">
        <label class="file-label">
          <input id="fileInput" type="file" accept=".json,.csv,.xlsx,.xls" />
          üìÇ Carregar dados (JSON/CSV/Excel)
        </label>
        <button id="downloadJSON">‚¨áÔ∏è Baixar JSON</button>
        <button id="exportPNG">üñºÔ∏è Exportar PNG</button>
        <button id="resetZoom">üîé Resetar Zoom</button>
        <button id="runTests">‚ñ∂Ô∏è Rodar Testes</button>
      </div>
    </header>

    <section class="left">
      <svg id="viz" width="100%" height="100%" viewBox="0 0 900 900"></svg>
      <div id="tooltip" class="tooltip"></div>
      <div id="legend" class="legend"></div>
    </section>

    <aside class="right">
      <div class="card">
        <div class="info-head">
          <div>
            <div id="nodeName" class="name">Comece clicando em um bloco</div>
            <div id="crumb" class="crumb">‚Äì</div>
          </div>
          <div class="chips"><span class="chip">Dica: clique com o bot√£o <span class="kbd">direito</span> para subir um n√≠vel</span></div>
        </div>
        <div id="desc" class="desc">Voc√™ pode carregar seu Excel no padr√£o A-D (Cliente, Coordena√ß√£o, Desdobramento, Descri√ß√£o). A descri√ß√£o <b>s√≥ aparece ao clicar no desdobramento</b>.<br/><br/>Ex.: A=Setorial ¬∑ B=Agro ¬∑ C=Qualifica√ß√£o ¬∑ D=Texto da descri√ß√£o</div>
        <div class="hint">‚Ä¢ L√¢minas mostram: Cliente (A) ‚Üí Coordena√ß√£o (B) ‚Üí Desdobramento (C).<br/>‚Ä¢ Descri√ß√£o (D) aparece <b>somente ao clicar</b> em um desdobramento.</div>
        <hr style="border-color: rgba(255,255,255,.08); margin:12px 0;">
        <div class="crumb" style="margin-bottom:6px">Filhos imediatos</div>
        <div id="children" class="list"></div>
      </div>
    </aside>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/save-svg-as-png@1.4.17/lib/saveSvgAsPng.min.js"></script>

  <script>
  // ================== DADOS DO EXCEL IMPORTADO (embutido) ==================
  // Se existir, a mandala carregar√° com estes dados.
  window.DATA_FROM_UPLOAD = [
  {"A": "Setorial", "B": "Agro", "C": "Sebraetec", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Agro", "C": "Programa Alimentos Paran√° (agroindustrias)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Agro", "C": "Programa Universidade Estadual do Paran√° (alunos e professores como multiplicadores)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Agro", "C": "Conecta Agro Paran√° -  SebraeTec Alimenta Agro", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Garage", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Capital Empreendedor/Investidor Anjo", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Conecta & Startups Procel", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Startup/Mulher de Neg√≥cios - Valida√ß√£o", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Sebrae pelo Paran√°  - Mapa dos Adesivos e Eventos", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "EB2  - Metodologia Valida√ß√£o", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Startup", "C": "Trilha Acelera 6 Meses (4 est√°gios)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "TIC", "C": "SebraeTec + Educa√ß√£o TIC  (Rob√≥tica, Programa√ß√£o, IA)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "TIC", "C": "Mobiliza√ß√£o dos empres√°rios Polo's Regionais - Polo Maring√°, Polo Londrina, Polo Nor Oeste, Polo Foz do Igua√ßu.  -  Mostra Empresarial (oficinas)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "TIC", "C": "Observat√≥rio Sebrae/TIC embarcada", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "TIC", "C": "Arena Sebrae - Cases e demonstra√ß√£o de solu√ß√µes (festival de inova√ß√£o)  1 por trimestre (roteiro) - Matriz  (palestras abertas empretec e rodadas de neg√≥cios)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "TIC", "C": "Miss√£o T√©cnica  para conhecer novos  modelos de neg√≥cio (SASS)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Turismo", "C": "SebraeTec + (Trilha Sebrae Turismo)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Turismo", "C": "Plano Estrat√©gico Municipais do Turismo / Regulador e Planejamento local  das cidades tur√≠sticas e Indutoras (Cidade tur√≠stica / Samara  - Gabinete)", "D": "xxxxxx", "value": 1.0},
  {"A": "Setorial", "B": "Turismo", "C": "Modelo de Governan√ßa  Municipal (Observat√≥rio)  Implementa√ß√£o dos Conselhos‚Äú, Inst. tur√≠sticas locais","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Turismo","C":"Rotas Tur√≠sticas -  Estrutura√ß√£o das Rotas ou Trilhas (10 rotas priorit√°rias e  19 rotas em desenvolvimento)  Rota do Caf√©, Rota do Queijo, Rota do Vinho, Rota Morros do Cristo, Rota dos Lagos (Nordeste)  Rota do V√¥o","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Turismo","C":"Sebrae pelo Paran√° -  Presen√ßa  nos eventos: FESTURIS, FESTUR e outros  (apresentar trilhas e cases)","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"IG","C":"Encantos Rurais - Selo de incremento de TURISMO","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"IG","C":"Cat√°logo de IGs do Paran√° (n√∫mero de IG's)  Conex√µes e oportunidades comerciais do mundo dos IGs","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Ind√∫stria","C":"SebraeTec","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Ind√∫stria","C":"Hub's  da Ind√∫stria (descentralizado  pelo PR)  Centro Agrotechs do PR  (Sistema FIEP)","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Ind√∫stria","C":"Qualifica√ß√£o da Industrializa√ß√£o (boas pr√°ticas fabrikas  e produ√ß√£o)  Kaizen (foco modelo Toyota) 5s  Padr√µes de Qualidade","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Com√©rcio","C":"SebraeTec","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Com√©rcio","C":"Qualifica√ß√£o em Vendas (opera√ß√µes de varejo e p√≥s venda)","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Com√©rcio","C":"Paran√° Gest√£o -  encerramento  ferramenta de melhorias","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Com√©rcio","C":"Trilha em Marketing - big data e IA","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Servi√ßo","C":"SebraeTec","D":"xxxxxx","value":1.0},
  {"A":"Setorial","B":"Servi√ßo","C":"Consultorias especializadas por categoria de servi√ßo e forma√ß√£o de pre√ßo","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cultura Empreendedora","C":"Professor Empreendedor","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cultura Empreendedora","C":"SEJA - J√≥vens e Mulheres Empreendedoras","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cultura Empreendedora","C":"+SENAC + SESC + SENAI + IFPR + UTFPR  (modelo de conex√£o com ETEs)  02  turmas 02  programas (empreende A√≠  + SEBRAE OFICIAL)","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Lideran√ßa","C":"Governan√ßa dos COLEGIADOS  de Coordena√ß√£o  e Lideran√ßas (mandala)","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Lideran√ßa","C":"L√≠deres do +PR  (Indicadores/Pain√©is ) Transpar√™ncia  e presta√ß√£o de contas das entregas","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Lideran√ßa","C":"Conselho Deliberativo - Sicoob PR -  (reconhecimento anual de melhores parceiros e lideres por cidade)","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cr√©dito e Investimentos","C":"Cr√©dito Orientado (linhas de cr√©dito e bancos)","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cr√©dito e Investimentos","C":"Acesso a Servi√ßos Financeiros","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Cr√©dito e Investimentos","C":"Cooperativas de Cr√©dito","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Inova√ß√£o","C":"PRojetos de Inova√ß√£o - IGs e Softlanding (internacionaliza√ß√£o)","D":"xxxxxx","value":1.0},
  {"A":"Institucional","B":"Pol√≠ticas P√∫blicas","C":"Desburocratiza√ß√£o","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Parcerias empresariais","C":"SebraeTec (chamamento anual de credenciamento)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Parcerias empresariais","C":"Cadeias Produtivas (plano comercial e iniciativas conjuntas)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Parcerias empresariais","C":"Hub's Regionais (rodadas de neg√≥cios)  e Centros integrados multisectoriais","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Parcerias empresariais","C":"Acesso a Mercado (rodadas, miss√µes e feiras)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Porta a Porta","C":"√ó  399 Cidades atendidas  - cobertura de mercado (atendentes em campo  e pontos de refer√™ncia)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Porta a Porta","C":"Diagn√≥stico +  direcionamento para Programas (Trilhas)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Porta a Porta","C":"Acesso as Salas, aos Programas setoriais e Universidades","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Sala do Empreendedor","C":"Programa EGP - \"cidades amigas do empreendedor\"","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Sala do Empreendedor","C":"Qualifica√ß√£o de Agentes  + PBs (sistemas,  pitch de atendimento e mapa de direcionamentos)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Sala do Empreendedor","C":"Qualifica√ß√£o do Atendimento (para todos os tipos de atendimento)  Telegram  como canal  de orienta√ß√µes e resolu√ß√µes (bots)","D":"xxxxxx","value":1.0},
  {"A":"Empresarial","B":"Pontos de Atendimento","C":"+ PONTOS de Di√°logo com os Empreendedores (ampliar 2x as unidades)","D":"xxxxxx","value":1.0}
];
</script>

  <script>
  /** =============================================================
   *  MANDALA INTERATIVA ‚Äì Sunburst clic√°vel + r√≥tulos abreviados
   *  Excel A-D (Cliente, Coordena√ß√£o, Desdobramento, Descri√ß√£o)
   *  FIXES: guards de root + right-click sobe 1 n√≠vel + paleta Sebrae
   ============================================================= */

  (function bootstrap(){
    if(typeof window.d3 === 'undefined'){
      console.error('D3 n√£o carregou.');
      return;
    }

    // ---------- Paleta Sebrae/PR ----------
    const BRAND = {
      'Empresarial': '#00A0DF', // X
      'Institucional': '#002D72', // Y
      'Setorial': '#0057A4' // Z
    };

    const by = sel => document.querySelector(sel);
    const size = {w:900,h:900};
    const radius = Math.min(size.w, size.h)/2 - 8;

    const svg = d3.select('#viz').attr('viewBox', `0 0 ${size.w} ${size.h}`).attr('width','100%').attr('height','100%');
    const g = svg.append('g').attr('transform',`translate(${size.w/2},${size.h/2})`);
    const arcsG = g.append('g');
    const labelsG = g.append('g');
    const centerG = g.append('g');
    const tooltip = by('#tooltip');

    const partition = d3.partition().size([2 * Math.PI, radius]);
    const arc = d3.arc().startAngle(d => d.x0).endAngle(d => d.x1).innerRadius(d => d.y0 + 2).outerRadius(d => Math.max(d.y0 + 2, d.y1 - 4));

    let root = null; let initialized = false; let currentFocus = null;

    function topName(d){ return d.ancestors()[1]?.data.name || d.data.name; }
    function mix(c){ const col = d3.color(c); col.opacity=1; return col.formatHex(); }
    function colorFor(d){
      const top = topName(d);
      const base = BRAND[top] || '#0077C8';
      // clarear por n√≠vel
      const level = d.depth;
      const col = d3.color(base);
      const factor = 0.15 * (level-1);
      col.r = Math.min(255, col.r + 255*factor);
      col.g = Math.min(255, col.g + 255*factor);
      col.b = Math.min(255, col.b + 255*factor);
      return mix(col);
    }

    // Abrevia r√≥tulos quando a l√¢mina √© pequena
    const STOPWORDS = new Set(['de','do','da','dos','das','e','para','por']);
    function abbreviate(str, maxLen){
      str = String(str||'').trim();
      if(str.length <= maxLen) return str;
      const words = str.split(/\s+/).filter(w=>!STOPWORDS.has(w.toLowerCase()));
      let out = [];
      for(const w of words){
        if(w.length > 6) out.push(w.slice(0,5) + '.');
        else out.push(w);
        if(out.join(' ').length >= maxLen) break;
      }
      let res = out.join(' ').trim();
      if(res.length > maxLen) res = res.slice(0, maxLen-1) + '‚Ä¶';
      return res || str.slice(0, maxLen-1)+'‚Ä¶';
    }

    function ensureRoot(){
      if(root && initialized) return true;
      try{ render(rowsToHierarchy(mapABCD(window.DATA_FROM_UPLOAD || []))); return true; }
      catch(err){ console.error('Falha ao garantir root:', err); return false; }
    }
    function resetZoomHandler(){ if(!ensureRoot()) return; selectNode(root,false); }
    function contextMenuHandler(){ if(!ensureRoot()) return; const up = (currentFocus?.parent) || root; selectNode(up, true); }

    function mapABCD(rows){
      const out = [];
      for(const r of (rows||[])){
        const A = r.A ?? r.Cliente ?? r['Coluna A'];
        const B = r.B ?? r['Coordena√ß√£o'] ?? r['Coordenacao'] ?? r['Coluna B'];
        let   C = r.C ?? r['Desdobramento'] ?? r['Coluna C'];
        const D = r.D ?? r['Descri√ß√£o'] ?? r['Descricao'] ?? r['Coluna D'] ?? '';
        let   V = r.value ?? r['Valor'] ?? r['%'] ?? r['percent'] ?? r['Percentual'];
        if(!(A && B)) continue;
        if(!C) C = B; // fallback: quando n√£o h√° desdobramento, usar a coordena√ß√£o
        V = (typeof V === 'string') ? parseFloat(V.replace(',','.')) : (+V || 1);
        if(!isFinite(V) || V<=0) V = 1;
        out.push({ path: `${A}/${B}/${C}`, value: V, description: D });
      }
      return out.length? out : rows; // aceita tamb√©m {path,value,description}
    }/${B}/${C}`, value: 1, description: D || '' });
      }
      return out.length? out : rows; // aceita tamb√©m {path,value,description}
    }

    function rowsToHierarchy(rows){
      const root = {name:'Mandala', children:[]};
      for(const r of (rows||[])){
        const path = String(r.path||'').trim(); if(!path) continue;
        const value = +r.value || 1; const description = r.description || '';
        const parts = path.split('/').map(s=>s.trim()).filter(Boolean);
        let cursor = root;
        for(let i=0;i<parts.length;i++){
          const name = parts[i];
          let node = (cursor.children||[]).find(c=>c.name===name);
          if(!node){ node = {name, children:[]}; (cursor.children||(cursor.children=[])).push(node); }
          if(i === parts.length-1){ node.value = (node.value||0) + value; if(description) node.description = description; }
          cursor = node;
        }
      }
      return root;
    }

    function render(data){
      root = d3.hierarchy(data).sum(d=>d.value||0).sort((a,b)=>b.value-a.value);
      partition(root);

      const firstLevel = root.children?.map(d=>d.data.name) || [];
      d3.select('#legend').selectAll('span').remove();
      d3.select('#legend').selectAll('span').data(firstLevel).enter().append('span').html(d=>`<i style="background:${BRAND[d]||'#0077C8'}"></i>${d}`);

      const nodes = root.descendants().filter(d => d.depth);
      const sel = arcsG.selectAll('path').data(nodes, d=>d.ancestors().map(a=>a.data.name).join('/'));

      const enter = sel.enter().append('path')
        .attr('fill', d => colorFor(d))
        .attr('stroke', '#0005').attr('stroke-width', .5).attr('d', arc)
        .on('mouseenter', (ev,d)=>{ tooltip.style.opacity = 1; tooltip.textContent = d.data.name; })
        .on('mousemove', (ev)=>{ tooltip.style.left = (ev.clientX) + 'px'; tooltip.style.top = (ev.clientY) + 'px'; })
        .on('mouseleave', ()=> tooltip.style.opacity = 0)
        .on('click', (ev,d)=> selectNode(d,true))
        .on('contextmenu', (ev)=>{ ev.preventDefault(); contextMenuHandler(); });

      sel.merge(enter).transition().duration(600).attrTween('d', function(d){
        const i = d3.interpolate(this._current || d, d); this._current = i(1); return t => arc(i(t));
      });

      sel.exit().remove();

      // centro
      centerG.selectAll('*').remove();
      centerG.append('circle').attr('r', radius*0.22).attr('fill', 'url(#centerGrad)').style('cursor','pointer').on('click', resetZoomHandler);
      centerG.append('text').attr('text-anchor','middle').attr('dy','.35em').style('font-weight',700).style('font-size','16px').text('Mandala');

      const defs = svg.select('defs').empty()? svg.append('defs'): svg.select('defs');
      let grad = defs.select('#centerGrad');
      if(grad.empty()){
        grad = defs.append('radialGradient').attr('id','centerGrad');
        grad.append('stop').attr('offset','0%').attr('stop-color','#ffffff10');
        grad.append('stop').attr('offset','100%').attr('stop-color','#ffffff05');
      }

      selectNode(root, false);
      updateLabels();
      initialized = true;
    }

    function selectNode(d, zoom){
      if(!d) return;
      currentFocus = d;
      const names = d.ancestors().reverse().map(x=>x.data.name);
      by('#nodeName').textContent = d.data.name || 'Mandala';
      by('#crumb').textContent = names.join(' ‚Ä∫ ');

      const isLeaf = !d.children || d.children.length === 0;
      if(isLeaf && d.depth >= 3){ by('#desc').innerHTML = (d.data.description || 'Sem descri√ß√£o cadastrada para este desdobramento.'); }
      else { by('#desc').innerHTML = 'Selecione um desdobramento para ver a descri√ß√£o.'; }

      const kids = (d.children || []).map(c=>({name:c.data.name, node:c}));
      const list = d3.select('#children').selectAll('button').data(kids, k=>k.name);
      list.enter().append('button').attr('class','chip').text(k=>k.name).on('click',(ev,k)=> selectNode(k.node,true));
      list.text(k=>k.name); list.exit().remove();

      if(zoom){ zoomTo(d); }
    }

    function updateLabels(){
      const nodes = (root ? root.descendants().filter(d=> d.depth>0) : []);
      const labelSel = labelsG.selectAll('text').data(nodes, d=>d.ancestors().map(a=>a.data.name).join('/'));

      const enter = labelSel.enter().append('text')
        .attr('text-anchor','middle')
        .style('pointer-events','none')
        .style('font-weight','600')
        .style('font-size','12px')
        .style('fill','#e6e9f2')
        .style('opacity',0.95)
        .text(d=>d.data.name);

      labelSel.merge(enter)
        .text(d=>{
          const angleSpan = d.x1 - d.x0; // radianos
          // threshold ~0.12 rad ~ 7 graus
          return angleSpan < 0.12 ? abbreviate(d.data.name, 16) : d.data.name;
        })
        .attr('transform', d=>{
          const angle = (d.x0 + d.x1)/2 - Math.PI/2;
          const r = (d.y0 + d.y1)/2;
          const x = Math.cos(angle) * r;
          const y = Math.sin(angle) * r;
          return `translate(${x},${y}) rotate(${(angle*180/Math.PI)})`;
        })
        .style('display', d => (d.x1 - d.x0) > 0.04 ? 'block' : 'none');

      labelSel.exit().remove();
    }

    function zoomTo(focus){
      if(!focus) return;
      const x = d3.scaleLinear().range([0, 2 * Math.PI]).domain([focus.x0, focus.x1]);
      const y = d3.scaleLinear().range([0, radius]).domain([focus.y0, 1]);

      arcsG.selectAll('path')
        .transition().duration(700)
        .tween('data', function(d){
          d.x0s = d.x0s ?? d.x0; d.x1s = d.x1s ?? d.x1; d.y0s = d.y0s ?? d.y0; d.y1s = d.y1s ?? d.y1;
          const ix  = d3.interpolate(d.x0s, d.x0);
          const ix1 = d3.interpolate(d.x1s, d.x1);
          const iy0 = d3.interpolate(d.y0s, d.y0);
          const iy1 = d3.interpolate(d.y1s, d.y1);
          return t => { d.x0s = ix(t); d.x1s = ix1(t); d.y0s = iy0(t); d.y1s = iy1(t); };
        })
        .attrTween('d', function(d){
          return () => arc({
            x0: Math.max(0, Math.min(2 * Math.PI, x(d.x0s ?? d.x0))),
            x1: Math.max(0, Math.min(2 * Math.PI, x(d.x1s ?? d.x1))),
            y0: Math.max(0, y(d.y0s ?? d.y0)),
            y1: Math.max(0, y(d.y1s ?? d.y1))
          });
        })
        .on('end', updateLabels);
    }

    // ---------- Importa√ß√£o manual (input) ----------
    document.getElementById('fileInput').addEventListener('change', async (ev)=>{
      const file = ev.target.files[0]; if(!file) return;
      const ext = file.name.split('.').pop().toLowerCase();
      try{
        if(ext === 'json'){
          const text = await file.text();
          render(rowsToHierarchy(mapABCD(JSON.parse(text))));
        } else if(ext === 'csv'){
          Papa.parse(file, {header:true, complete:(res)=>{ render(rowsToHierarchy(mapABCD(res.data))); }});
        } else if(ext === 'xlsx' || ext === 'xls'){
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, {type:'array'});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, {raw:true, defval:''});
          render(rowsToHierarchy(mapABCD(rows)));
        } else {
          alert('Formato n√£o suportado. Use JSON, CSV ou Excel.');
        }
      }catch(err){ alert('Falha ao ler o arquivo.'); console.error(err); }
    });

    // A√ß√µes topo
    document.getElementById('downloadJSON').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(window.DATA_FROM_UPLOAD||[], null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mandala-exemplo.json'; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });
    document.getElementById('exportPNG').addEventListener('click', ()=>{ const node = document.querySelector('#viz'); saveSvgAsPng(node, 'mandala.png', {scale:2, backgroundColor:'#0b1020'}); });
    document.getElementById('resetZoom').addEventListener('click', resetZoomHandler);

    // ------------------- Testes automatizados --------------------
    function runTests(){
      const results = [];
      try{ render(rowsToHierarchy(mapABCD(window.DATA_FROM_UPLOAD || []))); results.push('Render A‚ÄìD embutido: OK'); } catch(e){ results.push('Render A‚ÄìD embutido: FALHOU ‚Äì '+e.message); }

      try{
        // teste right-click: sobe um n√≠vel
        const deep = (root.children?.[0]?.children?.[0]) || root;
        selectNode(deep,true);
        const before = document.getElementById('crumb').textContent;
        contextMenuHandler();
        const after = document.getElementById('crumb').textContent;
        results.push(before !== after ? 'Right-click sobe um n√≠vel: OK' : 'Right-click: VERIFIQUE');
      } catch(e){ results.push('Right-click: FALHOU ‚Äì '+e.message); }

      try{
        // abrevia quando pequeno
        const sample = 'Pol√≠ticas P√∫blicas';
        const ab = (function(){
          const STOP=new Set(['de','do','da','dos','das','e','para','por']);
          function abbr(s,m){ s=String(s||''); if(s.length<=m) return s; const ws=s.split(/\s+/).filter(w=>!STOP.has(w.toLowerCase())); let out=[]; for(const w of ws){ if(w.length>6) out.push(w.slice(0,5)+'.'); else out.push(w); if(out.join(' ').length>=m) break;} let r=out.join(' ').trim(); if(r.length>m) r=r.slice(0,m-1)+'‚Ä¶'; return r || s.slice(0,m-1)+'‚Ä¶'; }
          return abbr(sample, 10);
        })();
        results.push(/\.|‚Ä¶/.test(ab) ? 'Abrevia√ß√£o: OK' : 'Abrevia√ß√£o: VERIFIQUE');
      } catch(e){ results.push('Abrevia√ß√£o: FALHOU ‚Äì '+e.message); }

      try{ resetZoomHandler(); results.push('Reset para raiz: OK'); } catch(e){ results.push('Reset raiz: FALHOU ‚Äì '+e.message); }

      console.log('[TESTES]', results.join(' | ')); alert(results.join('\n'));
    }
    document.getElementById('runTests').addEventListener('click', runTests);

    // Render inicial
    try{ render(rowsToHierarchy(mapABCD(window.DATA_FROM_UPLOAD || []))); }
    catch(err){ console.error('Falha no render inicial:', err); }
  })();
  </script>
</body>
</html>
