<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simulador Indicador Produtividade</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --azul:#2a4fda; --atl:#0b2574; --ink:#0f172a; --muted:#64748b;
    --grid:#e5e7eb; --bg:#f6f8fb; --ok:#047857; --warn:#b45309; --bad:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Figtree, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size:17px;
    background:var(--bg);
    color:var(--ink);
    line-height:1.35;
  }
  h1{margin:0;font-size:28px;color:var(--atl);letter-spacing:.2px}
  h2{margin:0 0 6px;font-size:22px;color:#0f172a}
  .wrap{max-width:980px;margin:22px auto;padding:0 18px}
  .card{
    background:#fff;border:1px solid var(--grid);border-radius:16px;
    box-shadow:0 10px 24px rgba(16,24,40,.06);padding:18px;margin-bottom:16px;position:relative
  }
  .titleCenter{display:flex;align-items:center;justify-content:center;position:relative}
  .helpBtn{
    position:absolute; right:16px; top:16px;
    display:inline-flex;align-items:center;gap:8px;
    background:#eef2ff; border:1px solid #dbeafe; color:#0b2574;
    border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; text-decoration:none
  }
  .helpIcon{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:999px;background:#e9edff;color:#1f3fdb;font-weight:800;font-size:13px;border:1px solid #d6ddff}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .cols-6{grid-column:span 6} .cols-12{grid-column:span 12}
  @media(max-width:900px){.cols-6{grid-column:span 12}}
  label{display:block;font-size:13px;color:#334155;margin:10px 0 6px}
  input[type=number]{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  input[readonly]{background:#f8fafc;border-color:#e2e8f0;color:#64748b}
  .btn{background:var(--azul);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:12px}
  .kpi{border:1px solid var(--grid);border-radius:14px;padding:16px;background:#fff}
  .kpi .title{font-size:13px;color:#334155}
  .kpi .value{font-size:26px;font-weight:800;color:var(--azul);line-height:1.1}
  .muted{color:var(--muted);font-size:13px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
  .ok{background:#ecfdf5;color:#047857;border:1px solid #a7f3d0}
  .warn{background:#fff7ed;color:#b45309;border:1px solid #fed7aa}
  .bad{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca}
  .suf{position:relative}
  .suf:after{content:'%';position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#64748b;font-size:12px}
  .note{font-size:13px;color:#475569;margin-top:8px}

  /* Meta layout */
  .metaHead{margin-bottom:10px}
  .metaRule{color:#50627a;font-size:13px;margin-top:4px}
  .metaGrid{display:grid;grid-template-columns:220px 1fr;gap:18px;align-items:start}
  @media(max-width:900px){.metaGrid{grid-template-columns:1fr}}
  .stack{display:flex;flex-direction:column;gap:12px}
  .kpisWide{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .kpi .statusText{font-size:16px;font-weight:800;margin-top:6px}

  /* Overlay/modal help */
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal{background:#fff;border-radius:16px;border:1px solid var(--grid);max-width:680px;width:100%;box-shadow:0 18px 44px rgba(2,6,23,.25)}
  .modal header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modal h3{margin:0;font-size:18px}
  .modal .close{background:#f1f5ff;border:1px solid #dbeafe;color:#0b2574;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .modal .body{padding:16px;font-size:15px;color:#0f172a}
  .modal .body p{margin:0 0 10px}
  .modal .body code{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="titleCenter">
      <h1>Simulador Indicador Produtividade</h1>
      <a class="helpBtn" onclick="openHelp('geral')"><span class="helpIcon">?</span> Ajuda</a>
    </div>
  </div>

  <!-- 1) Simulação do Resultado -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
      <h2>1) Simulação do Resultado</h2>
      <button class="btn" id="reset">Resetar</button>
    </div>
    <div class="grid">
      <div class="cols-6">
        <label>Resultado 1º ciclo</label>
        <div class="suf"><input type="number" id="r1" step="0.01" value="17.72" readonly></div>
        <label>Resultado 2º ciclo</label>
        <div class="suf"><input type="number" id="r2" step="0.01" value="35.82" readonly></div>
        <label>Resultado 3º ciclo</label>
        <div class="suf"><input type="number" id="x" step="0.01" placeholder="ex.: 28,50"></div>
      </div>
      <div class="cols-6">
        <label>Empresas 1º ciclo</label>
        <input type="number" id="n1" step="1" value="272" readonly>
        <label>Empresas 2º ciclo</label>
        <input type="number" id="n2" step="1" value="320" readonly>
        <label>Empresas 3º ciclo</label>
        <input type="number" id="n3" step="1" placeholder="ex.: 250">
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><div class="title">Consolidado atual (1º+2º)</div><div id="curr" class="value">0,00%</div></div>
      <div class="kpi"><div class="title">Consolidado final (com 3º ciclo)</div><div id="final" class="value">0,00%</div></div>
      <div class="kpi">
        <div class="title">Totais</div>
        <div class="value" id="pesos">—</div>
        <div class="muted" id="pesosDet">N1: — | N2: — | N3: —</div>
      </div>
    </div>
    <div class="note">Fórmula: (Resultado1 × Empresas1 + Resultado2 × Empresas2 + Resultado3 × Empresas3) ÷ (Empresas1 + Empresas2 + Empresas3)</div>
  </div>

  <!-- 2) Simulação da Meta -->
  <div class="card">
    <div class="metaHead">
      <h2>2) Simulação da Meta (CSN 95–115%)</h2>
      <div class="metaRule">Regra: execução entre 95% e 115% da meta. Se a projeção ficar fora, ajuste a meta ou revise o cenário de resultado.</div>
    </div>

    <div class="metaGrid">
      <div class="stack">
        <div>
          <label>Meta atual</label>
          <div class="suf"><input type="number" id="T" step="0.01" value="18.00" readonly></div>
        </div>
        <div>
          <label>Meta simulada</label>
          <div class="suf"><input type="number" id="Tsim" step="0.01" placeholder="ex.: 22,50"></div>
        </div>
      </div>

      <div class="kpisWide">
        <!-- Meta atual -->
        <div class="kpi">
          <div class="title">Faixa 95%–115% (meta atual)</div>
          <div id="faixa" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="title">Execução vs. meta atual</div>
          <div id="exec" class="value">—</div>
        </div>
        <div class="kpi">
          <div class="title">Status (meta atual)</div>
          <div class="statusText"><span id="status" class="badge">—</span></div>
        </div>

        <!-- Meta simulada -->
        <div class="kpi" id="simFaixaBox" style="display:none">
          <div class="title">Faixa 95%–115% (meta simulada)</div>
          <div id="simFaixa" class="value">—</div>
        </div>
        <div class="kpi" id="simExecBox" style="display:none">
          <div class="title">Execução vs. meta simulada</div>
          <div id="simExec" class="value">—</div>
        </div>
        <div class="kpi" id="simStatusBox" style="display:none">
          <div class="title">Status (meta simulada)</div>
          <div class="statusText"><span id="simStatus" class="badge">—</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ajuda (reutilizável) -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal">
    <header>
      <h3 id="helpTitle">Ajuda</h3>
      <button class="close" onclick="closeHelp()">Fechar</button>
    </header>
    <div class="body" id="helpBody">...</div>
  </div>
</div>

<script>
// Percentuais: entrada em % (18,00) -> decimal (0.18)
function pctIn(id){
  const el = document.getElementById(id);
  if(!el) return 0;
  const raw = (el.value||'').toString().replace(',','.');
  const num = parseFloat(raw);
  return isFinite(num) ? num/100 : 0;
}
function pct(x,dec=2){ return (x*100).toFixed(dec).replace('.',',') + '%'; }
function ratio(x,dec=1){ return (x*100).toFixed(dec).replace('.',',') + '%'; }

function compute(){
  const r1=pctIn('r1'), r2=pctIn('r2'), r3=pctIn('x');
  const n1=parseFloat(document.getElementById('n1').value)||0;
  const n2=parseFloat(document.getElementById('n2').value)||0;
  const n3=parseFloat(document.getElementById('n3').value)||0;
  const curr=(r1*n1 + r2*n2)/((n1+n2)||1);
  const final=(r1*n1 + r2*n2 + r3*n3)/((n1+n2+n3)||1);
  const total=(n1+n2+n3)||1;
  const w1=n1/total, w2=n2/total, w3=n3/total;
  return {r1,r2,r3,n1,n2,n3,curr,final,w1,w2,w3,total};
}

function computeMeta(final, Tdec){
  const T = Tdec;
  const low=0.95*T, high=1.15*T;
  const exec = T>0 ? final/T : 0;
  let status='ok', badge='Dentro da faixa';
  if(exec>1.15){ status='bad'; badge='Acima de 115%'; }
  else if(exec<0.95){ status='warn'; badge='Abaixo de 95%'; }
  return {T,low,high,exec,status,badge};
}

function applyStatus(el, status, text){
  el.className='badge ' + (status==='ok'?'ok':(status==='bad'?'bad':'warn'));
  el.textContent=text;
}

function updateAll(){
  const s=compute();
  document.getElementById('curr').textContent = pct(s.curr,2);
  document.getElementById('final').textContent = pct(s.final,2);
  document.getElementById('pesos').textContent = `${s.total} empresas`;
  document.getElementById('pesosDet').textContent = `N1: ${s.n1} | N2: ${s.n2} | N3: ${s.n3}`;

  // Meta atual
  const m = computeMeta(s.final, pctIn('T'));
  document.getElementById('faixa').textContent = `${pct(m.low,2)} — ${pct(m.high,2)}`;
  document.getElementById('exec').textContent = ratio(m.exec,1);
  applyStatus(document.getElementById('status'), m.status,
              (m.status==='ok')?'Dentro da faixa':(m.status==='bad'?'Acima de 115%':'Abaixo de 95%'));

  // Meta simulada (opcional)
  const TsimEl = document.getElementById('Tsim');
  const Tsim = pctIn('Tsim');
  const showSim = (TsimEl.value && !isNaN(Tsim) && Tsim>0);
  document.getElementById('simFaixaBox').style.display = showSim ? 'block' : 'none';
  document.getElementById('simExecBox').style.display = showSim ? 'block' : 'none';
  document.getElementById('simStatusBox').style.display = showSim ? 'block' : 'none';
  if(showSim){
    const ms = computeMeta(s.final, Tsim);
    document.getElementById('simFaixa').textContent = `${pct(ms.low,2)} — ${pct(ms.high,2)}`;
    document.getElementById('simExec').textContent = ratio(ms.exec,1);
    applyStatus(document.getElementById('simStatus'), ms.status,
                (ms.status==='ok')?'Dentro da faixa':(ms.status==='bad'?'Acima de 115%':'Abaixo de 95%'));
  }
}

// Help modal
const helpTexts = {
  geral: `<p><b>Como usar o simulador</b></p>
          <p>1) Informe o <b>Resultado 3º ciclo</b> (em %) e a <b>Empresas 3º ciclo</b> (em número). Os ciclos 1 e 2 ficam bloqueados.</p>
          <p>2) Veja o <b>Consolidado final</b> calculado automaticamente.</p>
          <p>3) Na seção de <b>Meta</b>, você pode testar uma <b>Meta simulada</b> para verificar a faixa 95–115% e o status.</p>
          <p>A fórmula é uma <b>média ponderada</b>: (Resultado1 × Empresas1 + Resultado2 × Empresas2 + Resultado3 × Empresas3) ÷ (Empresas1 + Empresas2 + Empresas3).</p>`
};

function openHelp(key){
  const ov = document.getElementById('overlay');
  const body = document.getElementById('helpBody');
  const title = document.getElementById('helpTitle');
  body.innerHTML = helpTexts[key] || '...';
  title.textContent = 'Ajuda do Simulador';
  ov.style.display='flex';
}
function closeHelp(){ document.getElementById('overlay').style.display='none'; }
document.getElementById('overlay').addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeHelp(); });

['x','n3','Tsim'].forEach(id=>document.getElementById(id).addEventListener('input', updateAll));
document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('x').value=30.00; document.getElementById('n3').value=250; document.getElementById('Tsim').value=''; updateAll();
});
updateAll();
</script>
</body>
</html>
