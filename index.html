<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mandala Interativa ‚Äì Sem depend√™ncias</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1630; --panel2:#0c1228; --text:#e6e9f2; --muted:#a9b1c7;
      --emp:#00A0DF; --inst:#002D72; --set:#0057A4; /* cores por cliente */
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 1200px at 85% -20%, #1e2a55 0%, #0b1020 55%);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .app{display:grid;grid-template-columns:1fr 380px;gap:16px;height:100vh;padding:16px;box-sizing:border-box}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:10px 12px}
    .left{position:relative;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;display:flex;align-items:center;justify-content:center}
    .right{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px;overflow:auto}
    .name{font-weight:700;font-size:18px}
    .crumb{color:var(--muted);font-size:12px}
    .chip{display:inline-block;background:#101834;border:1px solid rgba(255,255,255,.06);border-radius:999px;padding:6px 8px;margin:4px 6px 0 0}
    button{background:#101834;border:1px solid rgba(255,255,255,.06);color:var(--text);border-radius:10px;padding:8px 10px;cursor:pointer}
    svg{width:100%;height:100%}
    @media(max-width:980px){.app{grid-template-columns:1fr}.left{height:56vh}}
    #splash{position:fixed;inset:0;background:#0b1020;display:flex;align-items:center;justify-content:center;color:#e6e9f2;font-weight:700;z-index:99999}
    .tooltip{position:absolute;pointer-events:none;background:#000c;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;transform:translate(-50%,-120%);white-space:nowrap;opacity:0;transition:opacity .15s}
  </style>
</head>
<body>
  <div id="splash">üîß Inicializando visualiza√ß√£o...</div>
  <div class="app">
    <header>
      <div>üìç <b>Mandala Interativa</b> ‚Äì vers√£o sem depend√™ncias</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="runTests">‚ñ∂Ô∏è Rodar Testes</button>
        <button id="reset">üîé Resetar foco</button>
      </div>
    </header>
    <section class="left">
      <svg id="viz" viewBox="0 0 900 900" aria-label="mandala"></svg>
      <div id="tip" class="tooltip"></div>
    </section>
    <aside class="right">
      <div class="name" id="nodeName">Selecione um bloco</div>
      <div class="crumb" id="crumb">‚Äì</div>
      <div id="desc" style="margin-top:8px">A descri√ß√£o do <b>Desdobramento</b> aparece aqui ao clicar.</div>
      <hr style="border-color:rgba(255,255,255,.08);margin:12px 0">
      <div class="crumb">Filhos imediatos</div>
      <div id="children"></div>
      <div style="margin-top:8px" class="crumb">Dica: clique <b>com o bot√£o direito</b> para subir um n√≠vel.</div>
    </aside>
  </div>
  <script>
  // ================== DADOS DO EXCEL (embutidos previamente) ==================
  // Estes registros foram extra√≠dos da aba "Mandala" do seu arquivo.
  // Se quiser trocar, voc√™ pode substituir este array.
  window.DATA_FROM_UPLOAD = window.DATA_FROM_UPLOAD || [
    {"A":"Setorial","B":"Agro","C":"Sebraetec","D":"xxxxxx","value":1},
    {"A":"Setorial","B":"Agro","C":"Programa Alimentos Paran√° (agroindustrias)","D":"xxxxxx","value":1},
    {"A":"Setorial","B":"Startup","C":"Garage","D":"xxxxxx","value":1},
    {"A":"Institucional","B":"Pol√≠ticas P√∫blicas","C":"Desburocratiza√ß√£o","D":"xxxxxx","value":1},
    {"A":"Empresarial","B":"Sala do Empreendedor","C":"Programa EGP - cidades amigas do empreendedor","D":"xxxxxx","value":1}
  ];
  </script>
  <script>
  (function(){
    const splash = document.getElementById('splash');
    const svg = document.getElementById('viz');
    const W=900,H=900,CX=W/2,CY=H/2,R=420, PAD=3;
    let focus = null; // n√≥ focado

    const BRAND = { 'Empresarial':'var(--emp)', 'Institucional':'var(--inst)', 'Setorial':'var(--set)' };

    function removeSplash(msg){ if(splash){ splash.remove(); } if(msg){ console.log(msg); } }

    // ========= Util: √°rvore, layout de √¢ngulos e desenho =========
    function buildTree(rows){
      const root={name:'Mandala', children:[], __acc:0};
      const byName=(arr,n)=>{let x=arr.find(d=>d.name===n); if(!x){x={name:n,children:[],__acc:0};arr.push(x);} return x;};
      for(const r of rows){
        const A=r.A?.trim(); const B=r.B?.trim(); const C=r.C?.trim(); const D=r.D||''; const v=Number(r.value)||1;
        if(!(A&&B&&C)) continue;
        const nA=byName(root.children,A); nA.__acc+=v;
        const nB=byName(nA.children,B); nB.__acc+=v;
        let nC=byName(nB.children,C); nC.__acc+=v; if(D) nC.description=D;
      }
      root.__acc = root.children.reduce((s,c)=>s+c.__acc,0)||1;
      return root;
    }

    function layoutAngles(node, start, end, depth){
      node.x0=start; node.x1=end; node.depth=depth;
      const kids=node.children||[]; const total=node.__acc||1;
      let cur=start;
      for(const k of kids){
        const span=(k.__acc||1)/total*(end-start);
        layoutAngles(k, cur, cur+span, depth+1);
        cur+=span;
      }
    }

    function ringRadii(depth){
      const maxDepth=3; // Cliente, Coordena√ß√£o, Desdobramento
      const ring = R/maxDepth;
      const y0=ring*(depth-1), y1=ring*depth;
      return [y0+PAD, y1-PAD];
    }

    function polar(cx,cy,r,ang){ return [cx + r*Math.cos(ang), cy + r*Math.sin(ang)]; }

    function arcPath(d){
      const [ir,or]=ringRadii(d.depth);
      const a0=d.x0, a1=Math.max(a0+1e-6, d.x1);
      const p0=polar(CX,CY, or, a0), p1=polar(CX,CY, or, a1);
      const p2=polar(CX,CY, ir, a1), p3=polar(CX,CY, ir, a0);
      const large = (a1-a0) > Math.PI ? 1:0;
      return [
        'M',p0[0],p0[1],
        'A',or,or,0,large,1,p1[0],p1[1],
        'L',p2[0],p2[1],
        'A',ir,ir,0,large,0,p3[0],p3[1],
        'Z'
      ].join(' ');
    }

    function abbrev(text, max){
      text=String(text||''); if(text.length<=max) return text;
      const stop=new Set(['de','do','da','dos','das','e','para','por']);
      const words=text.split(/\s+/).filter(w=>!stop.has(w.toLowerCase()));
      const out=[]; for(const w of words){ out.push(w.length>6? (w.slice(0,5)+'.'):w); if(out.join(' ').length>=max) break; }
      let s=out.join(' '); if(s.length>max) s=s.slice(0,max-1)+'‚Ä¶'; return s||text.slice(0,max-1)+'‚Ä¶';
    }

    function colorFor(d){
      const top = d.depth===1? d.name : (d.ancestors? d.ancestors[1]?.name : d.topName);
      const base = BRAND[top] || '#0077c8';
      // clareia por profundidade
      const n = d.depth-1; // 0,1,2
      function lighten(hex, amt){
        const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if(!m) return hex;
        let r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
        r=Math.min(255, r+amt); g=Math.min(255, g+amt); b=Math.min(255, b+amt);
        return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
      }
      return lighten(base, Math.round(35*n));
    }

    function computeAncestors(node){
      function walk(n, parent){ n.parent=parent||null; n.ancestors=function(){ const a=[]; let x=this; while(x){ a.push(x); x=x.parent; } return a; }; (n.children||[]).forEach(c=>walk(c,n)); }
      walk(node,null);
    }

    function render(rootData){
      svg.innerHTML='';
      // fundo suave
      const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      bg.setAttribute('cx', CX); bg.setAttribute('cy', CY); bg.setAttribute('r', R*0.23);
      bg.setAttribute('fill', '#ffffff0f');
      svg.appendChild(bg);

      // desenha arcos
      const nodes = rootData.flatten.filter(n=>n.depth>0);
      for(const d of nodes){
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', arcPath(d));
        path.setAttribute('fill', colorFor(d));
        path.setAttribute('stroke', '#0005');
        path.setAttribute('stroke-width', '0.5');
        path.style.cursor='pointer';
        path.addEventListener('click', ev=> selectNode(d,true));
        path.addEventListener('contextmenu', ev=>{ ev.preventDefault(); rightClick(); });
        path.addEventListener('mousemove', ev=> showTip(ev,d.name));
        path.addEventListener('mouseleave', ev=> hideTip());
        svg.appendChild(path);
        // label
        const mid=(d.x0+d.x1)/2; const [ir,or]=ringRadii(d.depth); const r=(ir+or)/2; const pos=polar(CX,CY,r,mid);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', pos[0]); text.setAttribute('y', pos[1]);
        text.setAttribute('text-anchor','middle');
        text.setAttribute('font-size','12');
        text.setAttribute('fill','#e6e9f2');
        const ang=(mid*180/Math.PI);
        text.setAttribute('transform', `rotate(${ang} ${pos[0]} ${pos[1]})`);
        const span = d.x1-d.x0; text.textContent = span < 0.17 ? abbrev(d.name, 16) : d.name; // abrevia em fatias pequenas
        svg.appendChild(text);
      }

      // centro "bot√£o"
      const center = document.createElementNS('http://www.w3.org/2000/svg','circle');
      center.setAttribute('cx', CX); center.setAttribute('cy', CY); center.setAttribute('r', R*0.22);
      center.setAttribute('fill', '#00000020'); center.style.cursor='pointer';
      center.addEventListener('click', ()=>{ focus=root; updateRight(root); });
      center.addEventListener('contextmenu', ev=>{ ev.preventDefault(); rightClick(); });
      svg.appendChild(center);
    }

    // ============= UI lateral =============
    const $name=document.getElementById('nodeName');
    const $crumb=document.getElementById('crumb');
    const $desc=document.getElementById('desc');
    const $children=document.getElementById('children');
    const $tip=document.getElementById('tip');

    function showTip(ev, text){ $tip.textContent=text; $tip.style.left=ev.clientX+'px'; $tip.style.top=ev.clientY+'px'; $tip.style.opacity=1; }
    function hideTip(){ $tip.style.opacity=0; }

    function updateRight(d){
      const names = []; let x=d; while(x){ names.unshift(x.name); x=x.parent; }
      $name.textContent = d.name;
      $crumb.textContent = names.join(' ‚Ä∫ ');
      // descri√ß√£o somente em folha (desdobramento)
      const isLeaf = !d.children || d.children.length===0;
      $desc.innerHTML = (isLeaf && d.depth>=3) ? (d.description||'Sem descri√ß√£o cadastrada para este desdobramento.') : 'Selecione um desdobramento para ver a descri√ß√£o.';

      // filhos
      $children.innerHTML='';
      (d.children||[]).forEach(c=>{
        const b=document.createElement('button'); b.className='chip'; b.textContent=c.name; b.onclick=()=>selectNode(c,true); $children.appendChild(b);
      });
    }

    function selectNode(d, zoom){ focus=d||focus; updateRight(focus); /* sem anima√ß√£o/zoom por simplicidade e robustez */ }
    function rightClick(){ if(!focus) return; selectNode(focus.parent||root,true); }

    // ============= Bootstrap =============
    let root; // hierarquia pronta
    function init(){
      try{
        const rows = (Array.isArray(window.DATA_FROM_UPLOAD) && window.DATA_FROM_UPLOAD.length) ? window.DATA_FROM_UPLOAD : [];
        root = buildTree(rows);
        // preparar flatten e √¢ngulos
        layoutAngles(root, -Math.PI/2, Math.PI*3/2, 0);
        computeAncestors(root);
        const flat=[]; (function walk(n){ flat.push(n); (n.children||[]).forEach(walk); })(root); root.flatten=flat;
        render(root); focus=root; updateRight(root); removeSplash('ok');
      }catch(e){
        removeSplash('Falha ao iniciar');
        alert('Erro ao inicializar: '+(e&&e.message?e.message:e));
        console.error(e);
      }
    }

    // ============= Testes =============
    document.getElementById('runTests').onclick=function(){
      const results=[];
      try{ if(svg.querySelectorAll('path').length>0) results.push('Render: OK'); else results.push('Render: FALHOU'); }catch(e){ results.push('Render: EXC '+e.message); }
      try{ const firstLeaf = root.flatten.find(n=>!n.children||n.children.length===0); selectNode(firstLeaf,false); if(document.getElementById('desc').textContent.trim()) results.push('Descri√ß√£o em folha: OK'); else results.push('Descri√ß√£o em folha: VERIFIQUE'); }catch(e){ results.push('Descri√ß√£o: EXC '+e.message); }
      try{ const before=$crumb.textContent; rightClick(); const after=$crumb.textContent; results.push(before!==after? 'Right-click sobe n√≠vel: OK':'Right-click: VERIFIQUE'); }catch(e){ results.push('Right-click: EXC '+e.message); }
      alert(results.join('\n'));
    };
    document.getElementById('reset').onclick=function(){ selectNode(root,true); };

    // start
    init();
  })();
  </script>
</body>
</html>
